# Configuration Render.com pour NEOPRO
# Base de donnÃ©es : Supabase (externe)

services:
  # ============================================
  # CENTRAL SERVER (API Backend)
  # ============================================
  - type: web
    name: neopro-central
    env: node
    region: frankfurt
    plan: starter
    rootDirectory: central-server
    buildCommand: npm install && npm run build
    startCommand: npm start
    healthCheckPath: /health
    envVars:
      - key: NODE_ENV
        value: production
      - key: PORT
        value: 3001
      - key: API_VERSION
        value: v1
      # DATABASE_URL : configurer manuellement dans Render Dashboard
      # Format: postgresql://postgres.[project-ref]:[password]@aws-0-[region].pooler.supabase.com:6543/postgres
      - key: DATABASE_URL
        sync: false
      - key: DATABASE_SSL
        value: "true"
      - key: JWT_SECRET
        generateValue: true
      - key: JWT_EXPIRES_IN
        value: 8h
      - key: ALLOWED_ORIGINS
        value: https://neopro-admin.kalonpartners.bzh,https://control.neopro.fr,http://neopro.local,http://neopro.local:4200,http://192.168.4.1,http://192.168.4.1:4200
      - key: LOG_LEVEL
        value: info
      - key: STORAGE_TYPE
        value: local
      - key: STORAGE_PATH
        value: /data/videos

  # ============================================
  # CENTRAL DASHBOARD (Admin Frontend)
  # ============================================
  - type: web
    name: neopro-dashboard
    env: static
    region: frankfurt
    rootDirectory: central-dashboard
    buildCommand: npm install && npm run build:prod
    staticPublishPath: dist/neopro-central-dashboard/browser
    routes:
      - type: rewrite
        source: /health
        destination: /health.json
      - type: rewrite
        source: /*
        destination: /index.html
    headers:
      - path: /*
        name: Content-Security-Policy
        value: >
          default-src 'self';
          script-src 'self' 'unsafe-inline' 'unsafe-eval';
          style-src 'self' 'unsafe-inline';
          img-src 'self' data: https:;
          font-src 'self' data:;
          connect-src 'self'
                       https://neopro-central.onrender.com wss://neopro-central.onrender.com
                       https://neopro.onrender.com wss://neopro.onrender.com
                       https://neopro-admin.kalonpartners.bzh wss://neopro-admin.kalonpartners.bzh;
          frame-ancestors 'self';
          base-uri 'self';
      - path: /*
        name: X-Frame-Options
        value: SAMEORIGIN
      - path: /*
        name: X-Content-Type-Options
        value: nosniff
      - path: /*
        name: X-XSS-Protection
        value: 1; mode=block
    envVars:
      - key: NODE_VERSION
        value: "18"
